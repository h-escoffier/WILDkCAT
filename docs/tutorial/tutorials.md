# Example on _E. coli_ Core Model

This page shows a step-by-step example of the WILDkCAT pipeline on the _E. coli_ core model.

!!! info 

    The parameter `output_folder` specifies the directory where all files generated by the pipeline will be stored.  
    The purpose of this design is to centralize all results in a single location, with files being added progressively as each step is executed.  

---

## Prerequisites (_cf. [installation instructions](../installation.md)_)

- Install [WILDkCAT](../installation.md) from PyPI
- Install [CataPro](https://github.com/zchwang/CataPro) to predict kcat values using machine learning
- Download the [E. coli core model](http://bigg.ucsd.edu/static/models/e_coli_core.json)

```bash 
mkdir model
curl -O model/e_coli_core.json http://bigg.ucsd.edu/static/models/e_coli_core.json
```

Your working directory should contain the following folders:

- `venv/` - Folder containing the Python virtual environment
- `CataPro/` - Folder containing the CataPro repository
- `model/` - Folder containing the _E. coli_ core model (e_coli_core.json)

!!! note 

    All the files used and created in this tutorial are available in the [output folder](https://github.com/h-escoffier/WILDkCAT/tree/main/output) of the WILDkCAT repository

---

## 1 — Extract kcat values from _E. coli_ core model

*Time: ~3-4 min* 

First, for each combination of reaction, enzyme, and substrate(s) in the model, create a TSV file. 

Each row corresponds to a unique combination of reaction, enzyme, and substrate(s) and will be used to retrieve experimental kcat values from BRENDA and SABIO-RK in the next step.
The output file is named `kcat.tsv` and is saved in the specified output folder.

=== "Programmatic Access"
    ```python
    from wildkcat import run_extraction

    run_extraction(
        model_path="model/e_coli_core.json",
        output_folder="output"
    )
    ```

=== "Command Line Interface (CLI)"
    ```bash
    wildkcat extraction model/e_coli_core.json output
    ```

Example of the output file `kcat.tsv`:

| rxn | rxn_kegg | ec_code | ec_codes | direction | substrates_name | substrates_kegg | products_name | products_kegg | genes | uniprot | catalytic_enzyme | warning |
| :-- | :------- | :------ | :------- | :-------- | :-------------- | :-------------- | :------------ | :------------ | :---- | :------ | :--------------- | :------ |
| PFK |          | 2.7.1.11 | 2.7.1.11 | forward | ATP C10H12N5O13P3;D-Fructose 6-phosphate | C00002;C05345 | ADP C10H12N5O10P2;D-Fructose 1,6-bisphosphate;H+ | C00008;C00354;C00080 | b3916 | P0A796 | P0A796 | |
| ACALD | R00228 | 1.2.1.10 | 1.2.1.10 | reverse | Acetyl-CoA;H+;Nicotinamide adenine dinucleotide - reduced | C00024;C00080;C00004 | Acetaldehyde;Coenzyme A;Nicotinamide adenine dinucleotide | C00084;C00010;C00003 | b1241 | P0A9Q7 | P0A9Q7 | |

[View the generated report](extract_report.html)

---

## 2 — Retrieve experimental kcat values from BRENDA and/or SABIO-RK

*Time: ~7-10 min*

This function searches for experimentally measured turnover numbers (kcat values) in the BRENDA and/or SABIO-RK databases for the kcats listed in the input file. 
The retrieved values are filtered based on organism, temperature, and pH conditions. The closest matching kcat values are saved to the output file.


=== "Programmatic Access"
    ```python
    from wildkcat import run_retrieval

    run_retrieval(
        output_folder="output",
        organism="Escherichia coli",
        temperature_range=(20, 40),
        pH_range=(6.5, 7.5),
        database='both'
        )
    ```

=== "Command Line Interface (CLI)"
    ```bash
    wildkcat retrieval output 'Escherichia coli' 20 40 6.5 7.5
    ```


Example of the output file `kcat_retrieved.tsv`:

| rxn | rxn_kegg | ec_code | ec_codes | direction | substrates_name | substrates_kegg | products_name | products_kegg | genes | uniprot | catalytic_enzyme | warning | kcat | matching_score | kcat_substrate | kcat_organism | kcat_enzyme | kcat_temperature | kcat_ph | kcat_variant | kcat_db | kcat_id_percent | kcat_organism_score |
| :-- | :------- | :------ | :------- | :-------- | :-------------- | :-------------- | :------------ | :------------ | :---- | :------ | :--------------- | :------ | :--- | :------------- | :------------- | :------------ | :---------- | :--------------- | :------ | :----------- | :------ | :-------------- | :------------------ |
| PFK |          | 2.7.1.11 | 2.7.1.11 | forward | ATP C10H12N5O13P3;D-Fructose 6-phosphate | C00002;C05345 | ADP C10H12N5O10P2;D-Fructose 1,6-bisphosphate;H+ | C00008;C00354;C00080 | b3916 | P0A796 | P0A796 | | 88.0 | 1 | fructose 6-phosphate | Escherichia coli | P0A796 | 30.0 | 7.2 |  | brenda | 100.0 | 0.0 |
| ACALD | R00228 | 1.2.1.10 | 1.2.1.10 | reverse | Acetyl-CoA;H+;Nicotinamide adenine dinucleotide - reduced | C00024;C00080;C00004 | Acetaldehyde;Coenzyme A;Nicotinamide adenine dinucleotide | C00084;C00010;C00003 | b1241 | P0A9Q7 | P0A9Q7 | | 15.7 | 8 | acetaldehyde | Escherichia coli |  | 25 | 8.0 |  | brenda |  | 0.0 |

[View the generated report](retrieve_report.html)

!!! note 

    BRENDA requires a user account to access its data. In contrast, SABIO-RK is openly accessible and does not require registration. If you want to only use SABIO-RK, set the parameter `database='sabio_rk'` in the function or use the flag `--database sabio_rk` in the CLI command.

---

## 3 — Predict missing kcat values using machine learning

### 3.1 - Prepare input file for CataPro

Prepare the input file for CataPro by filtering out the kcat entries that were not found in the previous step and below a limit score (`limit_matching_score`). The resulting file will be used to predict missing kcat values using machine learning.

The function generates the files named `catapro_input.csv` and `catapro_input_substrates_to_smiles.tsv` in the subfolder `machine_learning`. 

!!! note

    The file `catapro_input_substrates_to_smiles.tsv` that maps substrate names to their corresponding SMILES will be used to match back the predicted kcat values to the original kcat entries after running CataPro.


=== "Programmatic Access"
    ```python
    from wildkcat import run_prediction_part1

    run_prediction_part1(
        output_folder="output",
        limit_matching_score=6
        )
    ```

=== "Command Line Interface (CLI)"
    ```bash
    wildkcat prediction-part1 output 6
    ```

The output file `catapro_input.csv` is formatted according to the requirements of [CataPro](https://github.com/zchwang/CataPro), meaning it can be directly used as input for kcat prediction.

!!! note 

    Before running predictions, make sure you have installed CataPro by following the installation instructions provided in their [GitHub repository](https://github.com/zchwang/CataPro?tab=readme-ov-file#create-the-catapro-environment).

Once installed, you can run CataPro with the following command:

```bash 
python CataPro.predict.py \
        -inp_fpath output/machine_learning/catapro_input.csv \
        -model_dpath models \
        -batch_size 64 \
        -device cuda:0 \
        -out_fpath output/machine_learning/catapro_output.csv
```

[View the generated report](predict_report.html)


### 3.2 - Integrate CataPro predictions

*Time: ~2-5 sec*

After running CataPro with the prepared input file, integrate the predicted kcat values back into the original kcat entries. The function matches the predicted values to the original entries using the substrate names and SMILES mapping file generated in the previous step.

=== "Programmatic Access"
    ```python
    from wildkcat import run_prediction_part2

    run_prediction_part2(
        output_folder="output", 
        catapro_predictions_path="output/machine_learning/catapro_output.csv", 
        limit_matching_score=6
        )
    ```

=== "Command Line Interface (CLI)"
    ```bash
    wildkcat prediction-part2 output output/machine_learning/catapro_output.csv 6
    ```


Example of the output file `kcat_full.tsv`:

| rxn | rxn_kegg | ec_code  | ec_codes | direction | substrates_name | substrates_kegg  | products_name | products_kegg | genes | uniprot | catalytic_enzyme | warning | kcat | db | matching_score | kcat_substrate | kcat_organism | kcat_enzyme | kcat_temperature | kcat_ph | kcat_variant | kcat_id_percent | kcat_organism_score |
| :-- | :------- | :------- | :------- | :-------- | :-------------- | :--------------- | :------------ | :-------------| :---- | :------ | :--------------- | :------ | :--- | :- | :------------- | :------------- | :------------ | :---------- | :--------------- | :------ | :----------- | :-------------- | :------------------ |
| PFK |          | 2.7.1.11 | 2.7.1.11 | forward | ATP C10H12N5O13P3;D-Fructose 6-phosphate | C00002;C05345 | ADP C10H12N5O10P2;D-Fructose 1,6-bisphosphate;H+ | C00008;C00354;C00080 | b3916 | P0A796 | P0A796 | | 88.0 | brenda | 1 | fructose 6-phosphate | Escherichia coli | P0A796 | 30.0 | 7.2 |  | 100.0 | 0.0 |
| ACALD | R00228 | 1.2.1.10 | 1.2.1.10 | reverse | Acetyl-CoA;H+;Nicotinamide adenine dinucleotide - reduced | C00024;C00080;C00004 | Acetaldehyde;Coenzyme A;Nicotinamide adenine dinucleotide | C00084;C00010;C00003 | b1241 | P0A9Q7 | P0A9Q7 |  | 20.2328 | catapro |  |  |  |  |  |  |  |  |

---

## 4 — Generate summary report

*Time: ~2-5 sec*

The final output file `kcat_full.tsv` contains both experimentally retrieved and machine learning predicted kcat values for each combination of reaction, enzyme, and substrate(s) in the _E. coli_ core model. This file can be used for integration into enzyme-constrained metabolic models.

The result can be visualized and summarized using the function `generate_summary_report`: 

=== "Programmatic Access"
    ```python
    from wildkcat import generate_summary_report

    generate_summary_report(
        model_path="model/e_coli_core.json", 
        output_folder="output"
        )
    ```

=== "Command Line Interface (CLI)"
    ```bash
    wildkcat report model/e_coli_core.json output
    ```

[View the generated report](general_report.html)
